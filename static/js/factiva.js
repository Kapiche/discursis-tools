// Generated by CoffeeScript 1.6.3
(function() {
  $(document).ready(function() {
    return $('#factiva-file-select').change(function(e) {
      var file, reader;
      $('input[type=checkbox]').attr('disabled', '').prop('checked', false);
      file = e.target.files[0];
      if (_.str.endsWith(file.name, ".html")) {
        reader = new FileReader();
        reader.onload = function() {
          var $htmlDoc, articles, codes;
          $htmlDoc = $(reader.result);
          articles = [];
          codes = [];
          $('.article table', $htmlDoc).each(function() {
            var article;
            article = {};
            $('tr', this).each(function() {
              var $cells, $code;
              $cells = $('td', this);
              $code = $('b', $cells[0]).text().toLowerCase();
              article[$code] = $($cells[1]).text();
              if ($.inArray($code, codes) < 0) {
                return codes.push($code);
              }
            });
            return articles.push(article);
          });
          $(codes).each(function() {
            return $("input[name='" + this.toLowerCase() + "']").removeAttr('disabled').prop('checked', true);
          });
          $('.output-container').show();
          return $('#factiva-save-btn').click(function() {
            var $checked, article, blob, code, line, text_code, text_to_save, _i, _j, _len, _len1;
            $checked = $('input:checked');
            if ($checked.length < 1) {
              alert('You haven\'t selected any fields!');
              return;
            }
            codes = [];
            text_code = void 0;
            $checked.each(function() {
              return codes.push($(this).attr('name'));
            });
            if ($.inArray("td", codes) >= 0) {
              text_code = "td";
            } else if ($.inArray("ls", codes) >= 0) {
              text_code = "ls";
            } else if ($.inArray("hd", codes) >= 0) {
              text_code = "hd";
            } else {
              alert("You must select one of tp, ls or hd to \ninclude as the text field in the Discursis CSV.");
              return;
            }
            codes = $.grep(codes, function(i) {
              return i !== text_code;
            });
            text_to_save = "text," + _.str.join(",", codes);
            console.log(text_code);
            for (_i = 0, _len = articles.length; _i < _len; _i++) {
              article = articles[_i];
              if (article[text_code]) {
                line = _.str.quote(article[text_code].replace(/"/g, '""'));
                for (_j = 0, _len1 = codes.length; _j < _len1; _j++) {
                  code = codes[_j];
                  if (article[code]) {
                    line = _.str.join(",", line, _.str.quote(article[code].replace(/"/g, '""')));
                  } else {
                    line += ',';
                  }
                }
                text_to_save = _.str.join("\n", text_to_save, line);
              }
            }
            blob = new Blob([text_to_save], {
              type: "text/csv;charset=utf-8"
            });
            return saveAs(blob, _.str.rtrim(file.name, ".html") + ".csv");
          });
        };
        return reader.readAsText(file);
      } else {
        return alert('That doesn\'t appear to be a HTML file.\n\nPlease choose a file that ends with ".html".');
      }
    });
  });

}).call(this);

/*
//@ sourceMappingURL=factiva.map
*/
